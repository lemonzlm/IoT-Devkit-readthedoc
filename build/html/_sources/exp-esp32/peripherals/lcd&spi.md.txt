
# LCD&SPI

## 概述

SPI是串行外设接口（Serial Peripheral Interface）的缩写，是一种高速的，全双工，同步的通信总线。

相比较于UART，SPI的工作方式略有不同。

SPI是一个同步的数据总线，也就是说它是用单独的数据线和一个单独的时钟信号来保证发送端和接收端的完美同步。

时钟是一个振荡信号，它告诉接收端在确切的时机对数据线上的信号进行采样。

产生时钟的一侧称为主机，另一侧称为从机。总是只有一个主机（一般来说可以是微控制器/MCU），但是可以有多个从机（后面详细介绍）；

数据的采集时机可能是时钟信号的上升沿（从低到高）或下降沿（从高到低）。

具体要看对SPI的配置；

整体的传输大概可以分为以下几个过程：

1. 主机先将NSS信号拉低，这样保证开始接收数据；

2. 当接收端检测到时钟的边沿信号时，它将立即读取数据线上的信号，这样就得到了一位数据（1bit）;

3. 由于时钟是随数据一起发送的，因此指定数据的传输速度并不重要，尽管设备将具有可以运行的最高速度（稍后我们将讨论选择合适的时钟边沿和速度）。

4. 主机发送到从机时：主机产生相应的时钟信号，然后数据一位一位地将从MOSI信号线上进行发送到从机；

5. 主机接收从机数据：如果从机需要将数据发送回主机，则主机将继续生成预定数量的时钟信号，并且从机会将数据通过MISO信号线发送；


具体如下图所示：

![image-20220805095644008](../IMG/image-20220805095644008.png)

> **❗注意**
>
> **SPI是“全双工”（具有单独的发送和接收线路），因此可以在同一时间发送和接收数据，另外SPI的接收硬件可以是一个简单的移位寄存器。这比异步串行通信所需的完整UART要简单得多，并且更加便宜；**

## SPI特性

SPI总线包括4条逻辑线，定义如下：

- MISO：Master input slave output 主机输入，从机输出（数据来自从机）；

- MOSI：Master output slave input 主机输出，从机输入（数据来自主机）；

- SCLK ：Serial Clock 串行时钟信号，由主机产生发送给从机；

- SS：Slave Select 片选信号，由主机发送，以控制与哪个从机通信，通常是低电平有效信号。


其他制造商可能会遵循其他命名规则，但是最终他们指的相同的含义。以下是一些常用术语；

- MISO也可以是SIMO，DOUT，DO，SDO或SO（在主机端）;

- MOSI也可以是SOMI，DIN，DI，SDI或SI（在主机端）;

- NSS也可以是CE，CS或SSEL;

- SCLK也可以是SCK;


本文将按照以下命名进行讲解[MISO, MOSI, SCK，NSS]

下图显示了单个主机和单个从机之间的典型SPI连接。

![image-20220805095850815](../IMG/image-20220805095850815.png)

### 时钟频率

SPI总线上的主机必须在通信开始时候配置并生成相应的时钟信号。在每个SPI时钟周期内，都会发生全双工数据传输。

主机在MOSI线上发送一位数据，从机读取它，而从机在MISO线上发送一位数据，主机读取它。

就算只进行单向的数据传输，也要保持这样的顺序。这就意味着无论接收任何数据，必须实际发送一些东西！在这种情况下，我们称其为虚拟数据；

从理论上讲，只要实际可行，时钟速率就可以是您想要的任何速率，当然这个速率受限于每个系统能提供多大的系统时钟频率，以及最大的SPI传输速率。

### 时钟极性 CKP/Clock Polarity

除了配置串行时钟速率（频率）外，SPI主设备还需要配置时钟极性。

根据硬件制造商的命名规则不同，时钟极性通常写为CKP或CPOL。时钟极性和相位共同决定读取数据的方式，比如信号上升沿读取数据还是信号下降沿读取数据；

CKP可以配置为1或0。这意味着您可以根据需要将时钟的默认状态（IDLE）设置为高或低。极性反转可以通过简单的逻辑逆变器实现。您必须参考设备的数据手册才能正确设置CKP和CKE。

CKP = 0：时钟空闲IDLE为低电平 0；

CKP = 1：时钟空闲IDLE为高电平1；

### 时钟相位 CKE /Clock Phase (Edge)

除配置串行时钟速率和极性外，SPI主设备还应配置时钟相位（或边沿）。根据硬件制造商的不同，时钟相位通常写为CKE或CPHA；

顾名思义，时钟相位/边沿，也就是采集数据时是在时钟信号的具体相位或者边沿；

CKE = 0：在时钟信号SCK的第一个跳变沿采样；

CKE = 1：在时钟信号SCK的第二个跳变沿采样；

### 时钟配置总结

综上几种情况，下图总结了所有时钟配置组合，并突出显示了实际采样数据的时刻；

其中黑色线为采样数据的时刻；

蓝色线为SCK时钟信号；

具体如下图所示；

![image-20220805095947933](../IMG/image-20220805095947933.png)

## 优缺点

### SPI通讯的优势

使SPI作为串行通信接口脱颖而出的原因很多；

- 全双工串行通信；

- 高速数据传输速率。

- 简单的软件配置；

- 极其灵活的数据传输，不限于8位，它可以是任意大小的字；

- 非常简单的硬件结构。从站不需要唯一地址（与I2C不同）。从机使用主机时钟，不需要精密时钟振荡器/晶振（与UART不同）。不需要收发器（与CAN不同）。


### SPI的缺点

没有硬件从机应答信号（主机可能在不知情的情况下无处发送）；

- 通常仅支持一个主设备；

- 需要更多的引脚（与I2C不同）；

- 没有定义硬件级别的错误检查协议；

- 与RS-232和CAN总线相比，只能支持非常短的距离；

## LCD

LCD （ Liquid Crystal Display 的简称）液晶显示器。LCD 的构造是在两片平行的玻璃基板当中放置液晶盒，下基板玻璃上设置TFT（薄膜晶体管），上基板玻璃上设置彩色滤光片，通过TFT上的信号与电压改变来控制液晶分子的转动方向，从而达到控制每个像素点偏振光出射与否而达到显示目的。

在我们的实验箱的esp32开发板ESP-WROVER-KIT上，已经附带有一块LCD屏幕ILI9341。

而本实验的内容则是解码 jpeg 图像并将其显示在 SPI 接口 LCD 上，图片位于main文件夹中。

本实验代码为esp官方标准spi的LCD驱动程序

- `esp-idf/examples/peripherals/lcd/tjpgd`

具体函数作用参考代码注释，想要了解ESP32的SPI驱动更多以及更深入的话可以前往乐鑫官方文档，以下为链接：

[SPI API 参考](https://docs.espressif.com/projects/esp-idf/zh_CN/v4.4.1/esp32/api-reference/peripherals/spi_master.html)

LCD与ESP-WROVER-KIT管脚连接情况

| ESP32 管脚 | LCD 信号 |
| ---------- | -------- |
| GPIO18     | 复位     |
| GPIO19     | SCL      |
| GPIO21     | D/C      |
| GPIO22     | CS       |
| GPIO23     | SDA      |
| GPIO25     | SDO      |
| GPIO5      | 背光     |

无需再去`menuconfig`中配置，默认引脚设置就是为ESP-WROVER-KIT服务的，具体请检查 `main.c` 代码内如下定义：

```c
#define EXAMPLE_LCD_PIXEL_CLOCK_HZ (10 * 1000 * 1000)
#define EXAMPLE_LCD_BK_LIGHT_ON_LEVEL  0
#define EXAMPLE_LCD_BK_LIGHT_OFF_LEVEL !EXAMPLE_LCD_BK_LIGHT_ON_LEVEL
#define EXAMPLE_PIN_NUM_DATA0          23  /*!< for 1-line SPI, this also refered as MOSI */
#define EXAMPLE_PIN_NUM_PCLK           19
#define EXAMPLE_PIN_NUM_CS             22
#define EXAMPLE_PIN_NUM_DC             21
#define EXAMPLE_PIN_NUM_RST            18
#define EXAMPLE_PIN_NUM_BK_LIGHT       5
```

## 构建和烧录



构建项目并将其烧写到板上，然后运行监控工具查看串行输出：

命令行界面：

`idf.py -p <你的实际串口号>  flash`

Clion界面：

选择 flash 并运行

## 示例输出

您将看到LCD中显示如下画面

![](../IMG/20220805143854.jpg)
